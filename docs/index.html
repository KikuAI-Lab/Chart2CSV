<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chart2CSV Demo - Extract Data from Charts</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --text-muted: #888;
      --accent: #00d4aa;
      --accent-dim: #00a080;
      --error: #ff4757;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    
    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--accent), #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle {
      color: var(--text-muted);
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
    }
    
    .api-key-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .api-key-section label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .api-key-section input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
      font-family: monospace;
    }
    
    .api-key-section input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .api-key-section small {
      display: block;
      margin-top: 0.5rem;
      color: var(--text-muted);
    }
    
    .api-key-section small a {
      color: var(--accent);
      text-decoration: none;
    }
    
    .dropzone {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 3rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 1.5rem;
    }
    
    .dropzone:hover, .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(0, 212, 170, 0.05);
    }
    
    .dropzone-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .dropzone p {
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    
    .dropzone .formats {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .preview-section {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .preview-section.active { display: block; }
    
    .preview-section h3 {
      margin-bottom: 1rem;
      font-weight: 600;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .extract-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--accent), var(--accent-dim));
      border: none;
      border-radius: 10px;
      color: #000;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, opacity 0.2s ease;
      margin-bottom: 1.5rem;
    }
    
    .extract-btn:hover { transform: translateY(-2px); }
    .extract-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .result-section {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    .result-section.active { display: block; }
    
    .result-section h3 {
      margin-bottom: 1rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .download-btn {
      padding: 0.5rem 1rem;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: #000;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .csv-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.9rem;
      max-height: 300px;
      overflow: auto;
      white-space: pre;
    }
    
    .status {
      text-align: center;
      padding: 1rem;
      color: var(--text-muted);
      display: none;
    }
    
    .status.active { display: block; }
    
    .status.error { color: var(--error); }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    footer {
      margin-top: 3rem;
      color: var(--text-muted);
      font-size: 0.9rem;
      text-align: center;
    }
    
    footer a {
      color: var(--accent);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <h1>Chart2CSV</h1>
  <p class="subtitle">Extract data from chart images using AI</p>
  
  <div class="container">
    <div class="api-key-section">
      <label for="apiKey">Mistral API Key</label>
      <input type="password" id="apiKey" placeholder="Enter your Mistral API key...">
      <small>Get your key at <a href="https://console.mistral.ai/" target="_blank">console.mistral.ai</a>. Your key stays in your browser.</small>
    </div>
    
    <div class="dropzone" id="dropzone">
      <div class="dropzone-icon">ðŸ“Š</div>
      <p><strong>Drop chart image here</strong></p>
      <p>or click to select</p>
      <p class="formats">PNG, JPG, WebP supported</p>
      <input type="file" id="fileInput" accept="image/*" hidden>
    </div>
    
    <div class="preview-section" id="previewSection">
      <h3>Preview</h3>
      <img class="preview-image" id="previewImage" alt="Chart preview">
    </div>
    
    <button class="extract-btn" id="extractBtn" disabled>Extract Data</button>
    
    <div class="status" id="status"></div>
    
    <div class="result-section" id="resultSection">
      <h3>
        Extracted Data
        <button class="download-btn" id="downloadBtn">Download CSV</button>
      </h3>
      <div class="csv-preview" id="csvPreview"></div>
    </div>
  </div>
  
  <footer>
    <p>Powered by <a href="https://github.com/kiku-jw/Chart2CSV" target="_blank">Chart2CSV</a> & Mistral AI</p>
    <p>Your images are processed directly via Mistral API â€” nothing is stored.</p>
  </footer>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const previewSection = document.getElementById('previewSection');
    const previewImage = document.getElementById('previewImage');
    const extractBtn = document.getElementById('extractBtn');
    const apiKeyInput = document.getElementById('apiKey');
    const status = document.getElementById('status');
    const resultSection = document.getElementById('resultSection');
    const csvPreview = document.getElementById('csvPreview');
    const downloadBtn = document.getElementById('downloadBtn');
    
    let currentFile = null;
    let currentCSV = '';
    
    // Load saved API key
    const savedKey = localStorage.getItem('mistral_api_key');
    if (savedKey) apiKeyInput.value = savedKey;
    
    apiKeyInput.addEventListener('change', () => {
      localStorage.setItem('mistral_api_key', apiKeyInput.value);
      updateExtractButton();
    });
    
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) handleFile(fileInput.files[0]);
    });
    
    function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        showStatus('Please select an image file', true);
        return;
      }
      currentFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewSection.classList.add('active');
        updateExtractButton();
      };
      reader.readAsDataURL(file);
      resultSection.classList.remove('active');
      status.classList.remove('active');
    }
    
    function updateExtractButton() {
      extractBtn.disabled = !(currentFile && apiKeyInput.value.trim());
    }
    
    function showStatus(msg, isError = false) {
      status.innerHTML = msg;
      status.className = 'status active' + (isError ? ' error' : '');
    }
    
    extractBtn.addEventListener('click', async () => {
      if (!currentFile || !apiKeyInput.value.trim()) return;
      
      extractBtn.disabled = true;
      showStatus('<span class="spinner"></span> Analyzing chart with Mistral Vision...');
      resultSection.classList.remove('active');
      
      try {
        const base64 = await fileToBase64(currentFile);
        const csv = await extractWithMistral(apiKeyInput.value.trim(), base64);
        
        currentCSV = csv;
        csvPreview.textContent = csv;
        resultSection.classList.add('active');
        status.classList.remove('active');
      } catch (err) {
        showStatus('Error: ' + err.message, true);
      } finally {
        extractBtn.disabled = false;
      }
    });
    
    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([currentCSV], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'chart_data.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
    
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    async function extractWithMistral(apiKey, base64Image) {
      const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'pixtral-12b-2409',
          messages: [
            {
              role: 'user',
              content: [
                {
                  type: 'text',
                  text: `You are a chart data extraction expert. Analyze this chart image and extract all data points.

Output ONLY a CSV with headers. For scatter/line charts use "x,y" columns. For bar charts use "label,value" columns.

Rules:
- Extract ALL visible data points
- Use the actual axis values, not pixel coordinates
- If axis labels are unclear, estimate based on grid lines
- Output raw CSV only, no markdown code blocks, no explanations

Example output for a line chart:
x,y
0,10
1,15
2,12
3,18`
                },
                {
                  type: 'image_url',
                  image_url: base64Image
                }
              ]
            }
          ],
          max_tokens: 4096
        })
      });
      
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.message || 'API request failed');
      }
      
      const data = await response.json();
      let csv = data.choices[0].message.content.trim();
      
      // Clean up markdown code blocks if present
      csv = csv.replace(/```csv\n?/g, '').replace(/```\n?/g, '').trim();
      
      return csv;
    }
  </script>
</body>
</html>
